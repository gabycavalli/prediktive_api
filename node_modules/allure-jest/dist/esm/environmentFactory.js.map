{"version":3,"file":"environmentFactory.js","names":["relative","env","allure","Stage","Status","serialize","extractMetadataFromString","getMessageAndTraceFromError","getStatusFromError","ReporterRuntime","createDefaultWriter","getEnvironmentLabels","getFrameworkLabel","getHostLabel","getLanguageLabel","getPackageLabel","getPosixPath","getSuiteLabels","getThreadLabel","parseTestPlan","setGlobalTestRuntime","AllureJestTestRuntime","getTestId","getTestPath","isTestPresentInTestPlan","last","shouldHookBeSkipped","createJestEnvironment","Base","_Class_brand","WeakSet","constructor","config","context","_classPrivateMethodInitSpec","_defineProperty","executables","steps","scopes","skippedTestsFullNamesByTestPlan","event","name","_assertClassBrand","_handleHookStart","call","hook","_handleHookPass","_handleHookFail","error","_handleSuiteStart","_handleSuiteEnd","_handleTestScopeStart","_handleTestStart","test","_handleTestPass","_handleTestFail","_handleTestScopeStop","_handleTestSkip","_handleTestTodo","_handleRunFinish","projectConfig","_ref","testEnvironmentOptions","resultsDir","restConfig","_objectWithoutProperties","_excluded","runtime","_objectSpread","writer","testPath","rootDir","testPlan","testRuntime","global","setup","teardown","handleAllureRuntimeMessage","message","executableUuid","runContext","applyRuntimeMessages","_getTestFullName","testTitle","arguments","length","undefined","newTestSuitePath","parent","newTestPath","concat","newTestId","_startScope","_stopScope","scopeUuid","fixtureUuid","startFixture","type","push","pop","updateFixture","r","status","PASSED","stage","FINISHED","stopFixture","BROKEN","statusDetails","trace","stack","_test$startedAt","cleanTitle","labels","links","newTestFullName","mode","testUuid","startTest","fullName","start","startedAt","RUNNING","JEST_WORKER_ID","_tr","_tr2","details","_statusAndDetails","errors","tr","updateTest","result","SKIPPED","writeTest","startScope","writeScope","_test$duration","_currentExecutable","suppressedErrors","expect","getState","statusAndDetails","stopTest","duration","_test$duration2","includes","writeEnvironmentInfo","writeCategoriesDefinitions","hasMultipleErrors","Array","isArray","exception","firstError","_convertToError","secondError","prototypeDescriptors","Object","getOwnPropertyDescriptors","getPrototypeOf","protoClone","create","clone"],"sources":["../../src/environmentFactory.ts"],"sourcesContent":["import type { EnvironmentContext, JestEnvironment, JestEnvironmentConfig } from \"@jest/environment\";\nimport type { Circus } from \"@jest/types\";\nimport { relative } from \"node:path\";\nimport { env } from \"node:process\";\nimport * as allure from \"allure-js-commons\";\nimport { Stage, Status, type StatusDetails, type TestResult } from \"allure-js-commons\";\nimport { type RuntimeMessage, type TestPlanV1, serialize } from \"allure-js-commons/sdk\";\nimport { extractMetadataFromString, getMessageAndTraceFromError, getStatusFromError } from \"allure-js-commons/sdk\";\nimport {\n  ReporterRuntime,\n  createDefaultWriter,\n  getEnvironmentLabels,\n  getFrameworkLabel,\n  getHostLabel,\n  getLanguageLabel,\n  getPackageLabel,\n  getPosixPath,\n  getSuiteLabels,\n  getThreadLabel,\n  parseTestPlan,\n} from \"allure-js-commons/sdk/reporter\";\nimport { setGlobalTestRuntime } from \"allure-js-commons/sdk/runtime\";\nimport { AllureJestTestRuntime } from \"./AllureJestTestRuntime.js\";\nimport type { AllureJestConfig, AllureJestEnvironment, AllureJestProjectConfig, RunContext } from \"./model.js\";\nimport { getTestId, getTestPath, isTestPresentInTestPlan, last, shouldHookBeSkipped } from \"./utils.js\";\n\nconst createJestEnvironment = <T extends typeof JestEnvironment>(Base: T): T => {\n  // @ts-expect-error (ts(2545)) Incorrect assumption about a mixin class: https://github.com/microsoft/TypeScript/issues/37142\n  return class extends Base {\n    testPath: string;\n    testPlan?: TestPlanV1;\n    runtime: ReporterRuntime;\n    runContext: RunContext = {\n      executables: [],\n      steps: [],\n      scopes: [],\n      skippedTestsFullNamesByTestPlan: [],\n    };\n\n    // config is AllureJestConfig in Jest v28 or greater. In older versions\n    // it's AllureJestProjectConfig. See https://github.com/jestjs/jest/pull/12461\n    constructor(config: AllureJestConfig | AllureJestProjectConfig, context: EnvironmentContext) {\n      super(config as JestEnvironmentConfig, context);\n\n      const projectConfig = \"projectConfig\" in config ? config.projectConfig : config;\n      const { resultsDir, ...restConfig } = projectConfig?.testEnvironmentOptions || {};\n\n      this.runtime = new ReporterRuntime({\n        ...restConfig,\n        writer: createDefaultWriter({ resultsDir }),\n      });\n      this.testPath = relative(projectConfig.rootDir, context.testPath);\n      this.testPlan = parseTestPlan();\n\n      // @ts-ignore\n      const testRuntime = new AllureJestTestRuntime(this as AllureJestEnvironment, this.global);\n\n      // @ts-ignore\n      this.global.allure = allure;\n\n      setGlobalTestRuntime(testRuntime);\n    }\n\n    setup() {\n      return super.setup();\n    }\n\n    teardown() {\n      return super.teardown();\n    }\n\n    handleAllureRuntimeMessage(message: RuntimeMessage) {\n      const executableUuid = last(this.runContext.executables);\n\n      this.runtime.applyRuntimeMessages(executableUuid, [message]);\n    }\n\n    handleTestEvent = (event: Circus.Event) => {\n      switch (event.name) {\n        case \"hook_start\":\n          this.#handleHookStart(event.hook);\n          break;\n        case \"hook_success\":\n          this.#handleHookPass(event.hook);\n          break;\n        case \"hook_failure\":\n          this.#handleHookFail(event.hook, event.error);\n          break;\n        case \"run_describe_start\":\n          this.#handleSuiteStart();\n          break;\n        case \"run_describe_finish\":\n          this.#handleSuiteEnd();\n          break;\n        case \"test_start\":\n          this.#handleTestScopeStart();\n          break;\n        case \"test_fn_start\":\n          this.#handleTestStart(event.test);\n          break;\n        case \"test_fn_success\":\n          this.#handleTestPass(event.test);\n          break;\n        case \"test_fn_failure\":\n          this.#handleTestFail(event.test);\n          break;\n        case \"test_done\":\n          this.#handleTestScopeStop(event.test);\n          break;\n        case \"test_skip\":\n          this.#handleTestSkip(event.test);\n          break;\n        case \"test_todo\":\n          this.#handleTestTodo(event.test);\n          break;\n        case \"run_finish\":\n          this.#handleRunFinish();\n          break;\n        default:\n          break;\n      }\n    };\n\n    #getTestFullName(test: Circus.TestEntry, testTitle: string = test.name) {\n      const newTestSuitePath = getTestPath(test.parent);\n      const newTestPath = newTestSuitePath.concat(testTitle);\n      const newTestId = getTestId(newTestPath);\n\n      return `${getPosixPath(this.testPath)}#${newTestId}`;\n    }\n\n    #handleSuiteStart() {\n      this.#startScope();\n    }\n\n    #handleSuiteEnd() {\n      this.#stopScope();\n    }\n\n    #handleHookStart(hook: Circus.Hook) {\n      if (shouldHookBeSkipped(hook)) {\n        return;\n      }\n\n      const scopeUuid = last(this.runContext.scopes);\n      const fixtureUuid = this.runtime.startFixture(scopeUuid, /after/i.test(hook.type) ? \"after\" : \"before\", {\n        name: hook.type,\n      })!;\n\n      this.runContext.executables.push(fixtureUuid);\n    }\n\n    #handleHookPass(hook: Circus.Hook) {\n      if (shouldHookBeSkipped(hook)) {\n        return;\n      }\n\n      const fixtureUuid = this.runContext.executables.pop()!;\n\n      this.runtime.updateFixture(fixtureUuid, (r) => {\n        r.status = Status.PASSED;\n        r.stage = Stage.FINISHED;\n      });\n      this.runtime.stopFixture(fixtureUuid);\n    }\n\n    #handleHookFail(hook: Circus.Hook, error: string | Circus.Exception) {\n      if (shouldHookBeSkipped(hook)) {\n        return;\n      }\n\n      const fixtureUuid = this.runContext.executables.pop()!;\n      const status = typeof error === \"string\" ? Status.BROKEN : getStatusFromError(error as Error);\n\n      this.runtime.updateFixture(fixtureUuid, (r) => {\n        r.status = status;\n        r.statusDetails = {\n          message: typeof error === \"string\" ? error : error.message,\n          trace: typeof error === \"string\" ? undefined : error.stack,\n        };\n        r.stage = Stage.FINISHED;\n      });\n      this.runtime.stopFixture(fixtureUuid);\n    }\n\n    #handleTestStart(test: Circus.TestEntry) {\n      const newTestSuitePath = getTestPath(test.parent);\n      const { cleanTitle, labels, links } = extractMetadataFromString(test.name);\n      const newTestFullName = this.#getTestFullName(test, cleanTitle);\n\n      if (this.testPlan && !isTestPresentInTestPlan(newTestFullName, this.testPlan)) {\n        test.mode = \"skip\";\n        this.runContext.skippedTestsFullNamesByTestPlan.push(newTestFullName);\n        return;\n      }\n\n      const testUuid = this.runtime.startTest(\n        {\n          name: cleanTitle,\n          fullName: newTestFullName,\n          start: test.startedAt ?? undefined,\n          stage: Stage.RUNNING,\n          labels: [\n            getLanguageLabel(),\n            getFrameworkLabel(\"jest\"),\n            getPackageLabel(this.testPath),\n            getHostLabel(),\n            getThreadLabel(env.JEST_WORKER_ID),\n            ...getEnvironmentLabels(),\n            ...getSuiteLabels(newTestSuitePath),\n            ...labels,\n          ],\n          links,\n        },\n        this.runContext.scopes,\n      );\n\n      this.runContext.executables.push(testUuid);\n\n      return testUuid;\n    }\n\n    #handleTestScopeStart() {\n      this.#startScope();\n    }\n\n    #handleTestScopeStop(test: Circus.TestEntry) {\n      const testUuid = this.runContext.executables.pop();\n\n      if (testUuid) {\n        const { details } = this.#statusAndDetails(test.errors);\n        let tr: TestResult | undefined;\n        this.runtime.updateTest(testUuid, (result) => {\n          tr = result;\n        });\n        // hook failure, finish as skipped\n        if (tr?.status === undefined && tr?.stage === Stage.RUNNING) {\n          this.runtime.updateTest(testUuid, (result) => {\n            result.stage = Stage.FINISHED;\n            result.status = Status.SKIPPED;\n            result.statusDetails = {\n              ...result.statusDetails,\n              ...details,\n            };\n          });\n        }\n\n        this.runtime.writeTest(testUuid);\n      }\n\n      this.#stopScope();\n    }\n\n    #startScope() {\n      const scopeUuid = this.runtime.startScope();\n\n      this.runContext.scopes.push(scopeUuid);\n    }\n\n    #stopScope() {\n      const scopeUuid = this.runContext.scopes.pop();\n      if (!scopeUuid) {\n        return;\n      }\n\n      this.runtime.writeScope(scopeUuid);\n    }\n\n    #handleTestPass(test: Circus.TestEntry) {\n      const testUuid = this.#currentExecutable();\n\n      if (!testUuid) {\n        return;\n      }\n      // @ts-ignore\n      const { suppressedErrors = [] } = this.global.expect.getState();\n      const statusAndDetails = this.#statusAndDetails(suppressedErrors as Circus.TestError[]);\n\n      this.runtime.updateTest(testUuid, (result) => {\n        result.stage = Stage.FINISHED;\n        result.status = statusAndDetails.status;\n        result.statusDetails = {\n          ...result.statusDetails,\n          ...statusAndDetails.details,\n        };\n      });\n\n      this.runtime.stopTest(testUuid, { duration: test.duration ?? 0 });\n    }\n\n    #handleTestFail(test: Circus.TestEntry) {\n      const testUuid = this.#currentExecutable();\n\n      if (!testUuid) {\n        return;\n      }\n\n      const { status, details } = this.#statusAndDetails(test.errors);\n\n      this.runtime.updateTest(testUuid, (result) => {\n        result.stage = Stage.FINISHED;\n        result.status = status;\n        result.statusDetails = {\n          ...result.statusDetails,\n          ...details,\n        };\n      });\n      this.runtime.stopTest(testUuid, { duration: test.duration ?? 0 });\n    }\n\n    #handleTestSkip(test: Circus.TestEntry) {\n      const newTestFullName = this.#getTestFullName(test);\n\n      if (this.runContext.skippedTestsFullNamesByTestPlan.includes(newTestFullName)) {\n        return;\n      }\n\n      // noinspection JSPotentiallyInvalidUsageOfThis\n      const testUuid = this.#handleTestStart(test);\n\n      if (!testUuid) {\n        return;\n      }\n\n      this.runtime.updateTest(testUuid, (result) => {\n        result.stage = Stage.FINISHED;\n        result.status = Status.SKIPPED;\n      });\n      // noinspection JSPotentiallyInvalidUsageOfThis\n      this.#handleTestScopeStop(test);\n    }\n\n    #handleTestTodo(test: Circus.TestEntry) {\n      // noinspection JSPotentiallyInvalidUsageOfThis\n      const testUuid = this.#handleTestStart(test);\n      if (!testUuid) {\n        return;\n      }\n\n      this.runtime.updateTest(testUuid, (result) => {\n        result.stage = Stage.FINISHED;\n        result.status = Status.SKIPPED;\n        result.statusDetails = {\n          message: \"TODO\",\n        };\n      });\n      // noinspection JSPotentiallyInvalidUsageOfThis\n      this.#handleTestScopeStop(test);\n    }\n\n    #handleRunFinish() {\n      this.runtime.writeEnvironmentInfo();\n      this.runtime.writeCategoriesDefinitions();\n    }\n\n    #currentExecutable() {\n      if (this.runContext.executables.length === 0) {\n        return undefined;\n      }\n      return this.runContext.executables[this.runContext.executables.length - 1];\n    }\n\n    #statusAndDetails(errors: Circus.TestError[]): { status: Status; details: Partial<StatusDetails> } {\n      if (errors.length === 0) {\n        return {\n          status: Status.PASSED,\n          details: {},\n        };\n      }\n      // jest collects all errors, but we need to report the first one because it's a reason why the test has been failed\n      const [error] = errors;\n      const hasMultipleErrors = Array.isArray(error);\n      const exception: Circus.Exception = hasMultipleErrors ? error[0] : error;\n\n      const firstError = this.#convertToError(exception);\n\n      // in case user throws non-Error type, the first exception is the user-thrown object,\n      // while the second one is provided by jest and has correct stack trace\n      if (hasMultipleErrors && error.length > 1) {\n        const secondError = this.#convertToError(error[1]);\n        if (!firstError.message) {\n          firstError.message = secondError.message;\n        }\n        if (!firstError.stack) {\n          firstError.stack = secondError.stack;\n        }\n      }\n\n      const details = getMessageAndTraceFromError(firstError);\n      const status = getStatusFromError(firstError);\n      return { status, details };\n    }\n\n    #convertToError(exception: Circus.Exception):\n      | Error\n      | {\n          message?: string;\n          stack?: string;\n        } {\n      if (!exception) {\n        return {};\n      }\n      // user may throw an object as well\n      if (typeof exception !== \"object\" || !(\"stack\" in exception)) {\n        return {\n          message: serialize(exception),\n        };\n      }\n\n      const prototypeDescriptors = Object.getOwnPropertyDescriptors(Object.getPrototypeOf(exception));\n      const protoClone = Object.create(null, prototypeDescriptors);\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      const clone = Object.create(protoClone, Object.getOwnPropertyDescriptors(exception));\n\n      return clone as\n        | Error\n        | {\n            message?: string;\n            stack?: string;\n          };\n    }\n  };\n};\n\nexport { createJestEnvironment };\n"],"mappings":"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","ignoreList":[]}